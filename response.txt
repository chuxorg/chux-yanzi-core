Refactored to use context-based dependency injection.
